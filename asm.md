# 汇编

---
###寄存器：
 **CR0**：（Control Register,CR）.32位的寄存器
 **CR1,CR2...**
 
###8086 flag 寄存器

| 15 | 14 | 13 | 12 | 11 | 10 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| --- |---|---| --- |--- |--- |---|---|---|---|---|---|---|---|---|--- |
| | | | | OF | DF | IF | TF | SF | ZF | | AF | | PF | | CF|

flag的1，3，5，12，13，14，15位在8086CPU中没有使用。
**ZF**：零标志位。记录相关指令执行后，其结果是否为0。如果为零，zf=1；否则，zf=0.（1表示逻辑真
**PF**：奇偶标志位。相关指令执行后，有偶数个为1的比特，则PF=1;否则PF=0.
**SF**：符号标志位。相关指令执行后，其结果为负，则SF=1;否则SF=0.
**CF**：进位标志位。如果最高位有向前进位或错位，则CF=1;否则CF=0.
**OF**：溢出标志位。假定进行的有符号数运算，如果溢出，则OF=1;否则OF=0.
**IF**：中断标志位。当CPU检测到可屏蔽中断信息时，如果IF=1，则处理器响应中断；否则忽略中断。
**TF**：陷阱标志位，为程序调试而设的。当设置TF=1，CPU处于单步执行指令的方式；当设置TF=0时，CPU正常执行程序。
**DF**：方向标志位。DF=0，每次操作后si,di递增，DF=1，...递减
**AF**：辅助进位标志位
在发生下列情况时，AF=1,否则AF=0
    1.在字操作时，发生低字节向高字节进位或借位时；
    2.在字节操作时，发生低4位向高4位进位或借位时。

---
###指令
**add**:。不允许两个操作数同时为内存单元，相加后，结果保存在目的操作数中。
 **mul**:乘法指令。两数相乘。要么都是8位，要么都是16位。8位，一个默认放AL中，另一个放在8位reg或内存字节单元中，结果默认放AX；16位，一个默认AX，另一个放在16位reg或内存字单元中，结果高位默认DX，低位在AX。
 **div**: 除法指令。操作数为除数。 1）16位的二进制数除以8位的二进制数，被除数必须在AX中；2）32位的二进制数除以16位的二进制数，被除数的高16位在DX中，低16位在AX中。
 **shr**:逻辑右移 ，将操作数连续向右移动指定的次数，每移动一次，“挤”出来的比特被移动到标志寄存器的CF位。左边空出来的位置用比特“0”（零）填充。
 **shl**:逻辑左移，上
 **ror**:循环右移，上，移出的比特即被送到标志寄存器的CF位，也送到左边空出的位。
 **rol**:循环左移，上
**cli**:(Clear Interrupt flag) 清除IF标志位
 **sli**:(SeT Interrupt flag) 置位IF标志
 **cld**:方向标志清零指令，将DF标志清零，以指示传送是正方向的。
     **std**:与cld功能相反，将DF标志置位（1），传送的方向是从高地址到底地址
     **in**:从端口读
     **out**:和in指令相反
     **or**:或。不允许两个操作数同时为内存单元，结果保存在目的操作数中。
     **xor**:异或。如果目的操作数和源操作数相同，其结果必定为0。xor dx dx，相当于把DX清零。
     **adc**:带进位加法。adc ax,bx 实现的功能是：(ax)=(ax)+(bx)+CF.
     **sbb**:带进位减法。同上
     **rep**:重复其后的串操作指令。重复前先判断CX是否为0，为0就结束重复，否则CX减1，重复其后的串操作指令。主要用在MOVS和STOS前。一般不用在LODS前。
     **xchg**:交换指令 。用于交换两个操作数的内容。
      **lodsb、lodsw**：把DS:SI指向的存储单元中的数据装入AL（lodsb）或AX（lodsw），然后根据DF标志增减SI
     **stosb、stosw**：把AL或AX中的数据装入ES:DI指向的存储单元，然后根据DF标志增减DI
     **movsb、movsw**：把DS:SI指向的存储单元中的数据装入ES:DI指向的存储单元中，然后根据DF标志分别增减SI和DI
     **scasb、scasw**：把AL或AX中的数据与ES:DI指向的存储单元中的数据相减，影响标志位，然后根据DF标志分别增减SI和DI
     **cmpsb、cmpsw**：把DS:SI指向的存储单元中的数据与ES:DI指向的存储单元中的数据相减，影响标志位，然后根据DF标志分别增减SI和DI
     **cmp**:

---
###中断 
####BLOS
####int 10h:
``` x86asm
mov ah,9     ; ?? (在光标位置显示字符)
mov al,'a'   ; 显示字符 a
mov bl,7     ; 颜色属性
mov bh,0     ; 第0页
mov dh,5     ; 行号 5
mov dl,12    ; 列号 12
mov cx,3     ; 字符重复个数
int 10h
```
####int 13h:
``` x86asm
; 复位软驱
ah=00h
dl=驱动器号（0表示A盘）
;------------------------------
; 从磁盘将数据读入es:bx指向的缓冲区
ah=02h
al=要读扇区数
ch=柱面（磁道）号
cl=起始扇区号
dh=磁头号
dl=驱动器号（0表示A盘）
; es:bx


```
---
###保护模式

    ; 某描述符
    low:0x8000ffff high:0x0040920b
    l:8000ffff h:0040920b
    l:10000000000000001111111111111111 h:10000001001001000001011
    l:1000000000000000 1111111111111111 h:(0) 1 0 0 0000 1 00 1 0010 00001011
    段基址：(0)00001011 1000000000000000   -> b8000
    段界限：0000 1111111111111111                                   -> ffff
    G:0
    D:1
    S:1
    p:1
    TYPE:0010

**G**位是粒度(Granularity)位,用于解释段界限的含义.当G位是‘0’时，段界限以字节为单位,段的扩展范围是从1字节到1兆字节（1B-1MB）,因为描述符中的界限值是20位。相反“1”，段界限以4KB位为单位，段的扩展范围从4KB到4GB.
**DPL**表示描述符的特权级(Descriptor Privilege Level,DPL)。[0,1，2，3],0是最高特权级别，3是最低特权级别。有些处理器指令（特权指令）只能由0特权级别的程序执行。
 **S**指定描述符的类型(Descriptor Type)。当S位是‘0’时，表示一个系统段；为‘1’时，表示一个代码段或数据段（or栈段）
**P**是段存在位(Segment Present)。指示描述符所对应的段是否存在。1存在。 
**D/B**位是“默认的操作数大小”(Default Operation Size)或者 “默认的栈指针大小”(Default Stack Pointer Size),又或者“上部边界"(Upper Bound)标志。如下，
——在可执行代码段描述符中，为‘D’位。D=1，在默认情况下指令使用32位地址及32位或8位操作                              数； D=0，默认使用16位地址及16位或8位操作数。
——在描述堆栈段(由SS寄存器指向的段)的描述符中。为‘B’位。B=1，隐式的堆栈访问指令使用ESP；                        B=0，使用SP。
——在向下扩展数据段的描述符中，为‘B’位。B=1，段的上部界限为4GB；B=0，段的上部界限为4KB；
 
 **L**位是64位代码段标(64-bit Code Segment),保留给64位处理器使用。
     **AVL**是软件可以使用的位，通常由操作系统来用。
     **TYPE**指示描述符的子类型，或者说是类别。

###TYPE
<table>
    <tr>
        <th>X(可执行)</th>
        <th>E(扩展方向)</th>
        <th>W(写)</th>
        <th>A(已访问)</th>
        <th>描述符类别</th>
        <th>含 义</th>
    </tr>
    <tr>
        <td>0</td>
        <td>0</td>
        <td>0</td>
        <td>X</td>
        <td rowspan="4">数据</td>
        <td>只读</td>
    </tr>
     <tr>
        <td>0</td>
        <td>0</td>
        <td>1</td>
        <td>X</td>
        <td>读写</td>
    </tr>  <tr>
        <td>0</td>
        <td>1</td>
        <td>0</td>
        <td>X</td>
       <td>只读，向下扩展</td>
    </tr>  <tr>
        <td>0</td>
        <td>1</td>
        <td>1</td>
        <td>X</td>
        <td>读写，向下扩展</td>
    </tr>
      <tr>
    <th>X(可执行)</th>
         <th>C(特级权依从)</th>       
        <th>R(读)</th>
        <th>A(已访问)</th>
        <th>描述符类别</th>
        <th>含 义</th>
    </tr>
    <tr>
        <td>1</td>
        <td>0</td>
        <td>0</td>
        <td>X</td>
        <td rowspan="4">代码</td>
        <td>只执行</td>
    </tr>
     <tr>
        <td>1</td>
        <td>0</td>
        <td>1</td>
        <td>X</td>
        <td>执行，读</td>
    </tr>  <tr>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>X</td>
       <td>只执行，依从的代码段</td>
    </tr>  <tr>
        <td>1</td>
        <td>1</td>
        <td>1</td>
        <td>X</td>
        <td>执行，读，依从的代码段</td>
    </tr>
</table>


###TYPE值
|TYPE值|数据段和代码段描述符|系统段和门描述符|
|-----|-----|-----|
|0|只读|<未定义>|
|1|只读，已访问|可用286TSS|
|2|读/写| LDT|
|3|读/写|忙的286TSS|
|4|只读，向下扩展|286调用门|
|5|只读，向下扩展，已访问|任务门|
|6|读/写，向下扩展|286中断门|
|7|读/写，向下扩展，已访问|286陷阱门|
|8|只执行|<未定义>|
|9|只执行，已访问|可用386TSS|
|A|执行/读|<未定义>|
|B|执行/读，已访问|忙的386TSS|
|C|只执行，一致码段|386调用门
|D|只执行，一致码段，已访问|<未定义>|
|E|执行/读，一致码段|386中断门|
|F|执行/读，一致码段，已访问|386陷阱门|

实模式下的6个段寄存器CS，DS，ES，FS，GS，SS。在保护模式下叫做段选择器。保护模式下访问一个段时，传送到段选择器的是段选择子。



<table>
    <tr>
        <th>15 —————————————————— 3</th>
        <th>2——————————1</th>
        <th>0</th>
     </tr>
    <tr>
        <td>描述符索引</td>
        <td>TI(Tabel Indicator)</td>
        <td>RPL(请求特权级)</td>
        </tr>
        </table>
TI=0，表示描述符在GDT中；TI=1，描述符在LDT中。